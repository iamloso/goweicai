# 定时任务使用指南

## 概述

项目已集成 `robfig/cron/v3` 定时任务调度器，支持灵活的 Cron 表达式配置。

## 配置说明

在 `configs/config.yaml` 中配置定时任务：

```yaml
scheduler:
  # Cron 表达式（支持秒级别）
  cron: "0 0 9 * * *"
  # 是否启动时立即执行一次
  run_on_start: true
```

### Cron 表达式格式

格式：`秒 分 时 日 月 周`

| 字段 | 允许值 | 允许的特殊字符 |
|------|--------|----------------|
| 秒   | 0-59   | * / , -        |
| 分   | 0-59   | * / , -        |
| 时   | 0-23   | * / , -        |
| 日   | 1-31   | * / , - ?      |
| 月   | 1-12   | * / , -        |
| 周   | 0-6    | * / , - ?      |

### 常用示例

```yaml
# 每天 9:00 执行
cron: "0 0 9 * * *"

# 每 30 分钟执行一次
cron: "0 */30 * * * *"

# 每天 9:00 和 15:00 执行
cron: "0 0 9,15 * * *"

# 每周一到周五 9:00 执行
cron: "0 0 9 * * 1-5"

# 每小时的第 0 分和第 30 分执行
cron: "0 0,30 * * * *"

# 每 5 秒执行一次（测试用）
cron: "*/5 * * * * *"
```

## 使用方法

### 1. 编译项目

```bash
make build
```

### 2. 前台运行（开发测试）

```bash
make run
```

按 `Ctrl+C` 可以优雅退出。

### 3. 后台运行（生产环境）

```bash
# 启动后台服务
make daemon

# 查看运行状态
make status

# 查看日志
make logs

# 停止服务
make stop
```

### 4. 查看日志

日志文件位置：`cmd/goweicai/goweicai.log`

```bash
# 实时查看日志
tail -f cmd/goweicai/goweicai.log

# 或使用 make 命令
make logs
```

## 配置参数说明

### `cron`
- **类型**: string
- **必填**: 否
- **默认值**: `"0 0 9 * * *"` (每天 9:00)
- **说明**: 定时任务的 Cron 表达式

### `run_on_start`
- **类型**: boolean
- **必填**: 否
- **默认值**: false
- **说明**: 是否在程序启动时立即执行一次任务（不等待第一次定时触发）

## 工作原理

1. **程序启动**: 加载配置，初始化定时任务调度器
2. **立即执行**（可选）: 如果 `run_on_start: true`，先执行一次任务
3. **定时调度**: 根据 Cron 表达式定时执行任务
4. **优雅退出**: 接收到 `SIGINT` 或 `SIGTERM` 信号时，停止调度器并退出

## 日志示例

```
ts=2024-12-24T10:00:00+08:00 level=INFO caller=main.go:61 msg=配置加载成功
ts=2024-12-24T10:00:00+08:00 level=INFO caller=main.go:107 msg="定时任务已配置，Cron 表达式: 0 0 9 * * *"
ts=2024-12-24T10:00:00+08:00 level=INFO caller=main.go:112 msg=启动时立即执行一次任务...
ts=2024-12-24T10:00:00+08:00 level=INFO caller=main.go:88 msg=开始执行定时任务...
ts=2024-12-24T10:00:05+08:00 level=INFO caller=main.go:92 msg=定时任务执行成功
ts=2024-12-24T10:00:05+08:00 level=INFO caller=main.go:117 msg=定时任务调度器已启动
```

## 故障排查

### 任务未按时执行

1. 检查 Cron 表达式是否正确
2. 查看日志是否有错误信息
3. 确认系统时间是否正确

### 程序异常退出

1. 查看日志文件 `cmd/goweicai/goweicai.log`
2. 检查数据库连接是否正常
3. 确认配置文件格式是否正确

### 后台进程无法启动

1. 检查端口是否被占用
2. 确认是否有足够的权限
3. 查看是否已有进程在运行：`make status`

## Makefile 命令汇总

| 命令 | 说明 |
|------|------|
| `make build` | 编译项目 |
| `make run` | 前台运行 |
| `make daemon` | 后台运行 |
| `make status` | 查看运行状态 |
| `make logs` | 实时查看日志 |
| `make stop` | 停止后台进程 |
| `make clean` | 清理编译产物和日志 |
| `make test` | 运行测试 |
| `make deps` | 安装依赖 |
| `make fmt` | 格式化代码 |

## 注意事项

1. **时区**: 请确保服务器时区设置正确
2. **日志轮转**: 生产环境建议配置日志轮转，避免日志文件过大
3. **监控**: 建议配置进程监控（如 systemd、supervisor）确保服务高可用
4. **资源限制**: 根据实际情况调整任务执行频率，避免过度消耗资源
